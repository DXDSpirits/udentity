!function(){moment.lang("zh-cn");var e=_.debounce(function(){$(".views-wrapper").height($(window).height())},300);$(window).resize(e),e(),$("body").on("click","[data-route]",function(e){var i=$(e.currentTarget).data("route");"return"==i?window.history.back():"preview"==i?t.previewStory(t.story.get("name")):t.router.navigate(i)});var t={Version:"1.0.0",Models:{},Views:{},Pages:{}};t.pageRouter=new function(e){this.pages=e,this.history={active:null,stack:[]},this.goTo=function(e,t){var i=this.pages[e],o=_.last(this.history.stack);(t||(t={})).caller=t.caller||this.history.active,i&&(i==o?(this.history.active.leave(),this.pushNext?this.history.stack.push(this.history.active):this.history.stack.length-=1,t.reverse=!this.pushNext,i.go(t),this.history.active=i):(this.history.active&&(this.history.active.leave(),this.history.stack.push(this.history.active)),i.go(t),this.history.active=i)),this.pushNext=!1},this.clearHistory=function(){this.history.stack.length=0},this.refreshActivePage=function(){this.history.active.refresh()},this.goBack=function(){if(this.history.stack.length>0){var e=this.history.stack.pop();this.history.active=e,this.history.active.showPage({reverse:!0})}},this.pop=function(){if(this.history.stack.length>0){var e=this.history.stack.pop();this.history.active=e}}}(t.Pages),t.getTemplate=function(e){return $("#template-"+e).html()};var i,o,n=500;Amour.ajax.on("start",function(){clearTimeout(i),clearTimeout(o),$("#apploader").removeClass("invisible")}),Amour.ajax.on("stop",function(){i=setTimeout(function(){$("#apploader").addClass("invisible"),n=500},n)}),Amour.ajax.on("error",function(){$("#apploader .ajax-error").removeClass("hidden"),o=setTimeout(function(){$("#apploader .ajax-error").addClass("hidden")},n=1500)}),Amour.ajax.on("unauthorized",function(){var e="/accounts/?url="+encodeURIComponent(location.href);t.openUrl(e,{replace:!0})}),Amour.ajax.on("forbidden",function(){var e="/accounts/?url403="+encodeURIComponent(location.href);t.openUrl(e,{replace:!0})}),t.vent=new Amour.EventAggregator,t.start=function(){Amour.trigger("ComposerAppReady"),Backbone.history.start()},window.App=t}(),function(){App.PageView=Amour.View.extend({disablePage:function(){this.undelegateEvents(),this.go=function(){},this.refresh=function(){},this.showPage=function(){}},initView:function(){if(!this.el)return void this.disablePage();this.views={},_.bindAll(this,"showPage","go","refresh","render","reset");var e=this.$el;this.$(".wrapper").on("webkitAnimationEnd",function(t){var i=t.originalEvent.animationName;"slideouttoleft"==i||"slideouttoright"==i?e.trigger("pageClose"):("slideinfromright"==i||"slideinfromleft"==i)&&e.trigger("pageOpen")}),this.initPage&&this.initPage()},leave:function(){},go:function(e){this.options=e||{},this.reset();var t=this.render,i=_.once(function(){t()});_.delay(i,1e3),this.$el.one("pageOpen",i),this.showPage()},refresh:function(){var e=this.render,t=_.once(function(){e()});_.delay(t,1e3),this.$el.one("pageOpen",t),this.showPage()},reset:function(){},showPage:function(e){var t,e=e||this.options||{},i=!this.$el.hasClass("view-hidden");i?(t=this.$el.clone().prependTo(".views-wrapper"),t.find(".wrapper").scrollTop(this.$(".wrapper").scrollTop()),this.$el.addClass("view-hidden")):t=$('.view:not(".view-hidden")');var o=_.once(function(){t.removeClass("view-prev").removeClass("view-prev-reverse"),i?t.remove():t.addClass("view-hidden"),t.find("input").blur()});t.addClass("view-prev"),e.reverse&&t.addClass("view-prev-reverse"),_.delay(o,1e3),t.one("pageClose",o);var n=this.$el,s=_.once(function(){n.removeClass("view-next").removeClass("view-next-reverse"),n.find("input").blur(),window.scrollTo(0,0)});n.removeClass("view-hidden"),n.addClass("view-next"),e.reverse&&n.addClass("view-next-reverse"),_.delay(s,1e3),n.one("pageOpen",s)}})}(),function(){var e=App.pageRouter;App.router=new(Backbone.Router.extend({navigate:function(t,i){i=i||{},i.trigger=!(i.trigger===!1),i.replace&&e.pop(),e.pushNext=!0,Backbone.Router.prototype.navigate.call(this,t,i)},initialize:function(){this.route("*path","index"),this.route(/product\/(\d+)/,"product"),this.route(/product\/(\d+)\/address/,"productAddress"),this.route(/brand\/(\d+)/,"brand"),this.route(/brand\/(\d+)\/address/,"brandAddress"),this.route(/topic\/(\d+)/,"topic"),this.route(/topic\/(\d+)\/comments/,"comments")},index:function(e){this.navigate("topic/96",{replace:!0})},product:function(t){e.goTo("Product",{productId:t})},brand:function(t){e.goTo("Brand",{brandId:t})},topic:function(t){e.goTo("Topic",{topicId:t})},comments:function(t){e.goTo("TopicComments",{topicId:t})},brandAddress:function(t){e.goTo("Address",{brandId:t})},productAddress:function(t){e.goTo("Address",{productId:t})}}))}(),function(){var e=9,t=Amour.Model.extend({url:Amour.APIRoot+"beacon/data/getItemBycityName.do"}),i=Amour.Collection.extend({url:Amour.APIRoot+"beacon/data/listSameCategoryItemsByid.do"}),o=Amour.Collection.extend({url:Amour.APIRoot+"beacon/data/listItemByBid.do"}),n=Amour.ModelView.extend({template:App.getTemplate("product-detail")}),s=Amour.CollectionView.extend({ModelView:Amour.ModelView.extend({events:{click:"viewDetail"},className:"media-item",template:'<div class="img" data-bg-src="{{apiFullpath img}}"></div><div class="name">{{name}}</div><div>￥{{price}}</div>',viewDetail:function(){App.router.navigate("product/"+this.model.id)}})});App.Pages.Product=new(App.PageView.extend({events:{"click .store .btn":"viewStores"},initPage:function(){this.product=new t,this.similarProducts=new i,this.brandProducts=new o,this.views={product:new n({model:this.product,el:this.$(".product-wrapper")}),similarProducts:new s({collection:this.similarProducts,el:this.$(".similar-products .media-list")}),brandProducts:new s({collection:this.brandProducts,el:this.$(".brand-products .media-list")})}},viewStores:function(){App.router.navigate(["product",this.product.id,"address"].join("/"))},render:function(){var t=this.options.productId,i=this;this.product.fetch({dataType:"jsonp",data:{id:t},success:function(t){var o=i.product.get("brand").id;i.brandProducts.fetch({dataType:"jsonp",data:{id:o,start:0,size:e}}),i.$(".store").toggleClass("hidden",1==t.get("online"))}}),this.similarProducts.fetch({dataType:"jsonp",data:{id:t,size:e}})}}))({el:$("#view-product")})}(),function(){var e=Amour.Model.extend({url:Amour.APIRoot+"beacon/data/getBrand.do"}),t=Amour.Collection.extend({url:Amour.APIRoot+"beacon/data/listItemByBid.do"}),i=Amour.Collection.extend({url:Amour.APIRoot+"beacon/data/listTopicByBid.do"}),o=Amour.ModelView.extend({events:{"click .more":"showMore"},template:App.getTemplate("brand-detail"),render:function(){Amour.ModelView.prototype.render.call(this);var e=this.$(".description").height();if(e>50){var t=this.model.get("description").substr(0,$(window).width()/10);this.$(".desc").text(t+" ......"),this.$(".description").addClass("ellipsis")}return this},showMore:function(){$("#desc-full").find("h4").text("品牌介绍").end().find("article").text(this.model.get("description")).end().removeClass("invisible").one("click",function(){$(this).addClass("invisible")})}}),n=Amour.CollectionView.extend({ModelView:Amour.ModelView.extend({events:{click:"viewDetail"},className:"topic-media-item",template:'<div class="img" data-bg-src="{{apiFullpath img}}"><div class="title">{{title}}</div></div>',viewDetail:function(){App.router.navigate("topic/"+this.model.id)}})}),s=Amour.CollectionView.extend({ModelView:Amour.ModelView.extend({events:{click:"viewDetail"},className:"product-media-item",template:App.getTemplate("product-media-item"),viewDetail:function(){App.router.navigate("product/"+this.model.id)}})});App.Pages.Brand=new(App.PageView.extend({events:{"click .store .btn":"viewStores"},initPage:function(){this.brand=new e,this.products=new t,this.topics=new i,this.views={brand:new o({model:this.brand,el:this.$(".brand-wrapper")}),products:new s({collection:this.products,el:this.$(".brand-products .media-list")}),topics:new n({collection:this.topics,el:this.$(".brand-topics .media-list")})}},viewStores:function(){App.router.navigate(["brand",this.brand.id,"address"].join("/"))},render:function(){var e=this.options.brandId;this.brand.fetch({dataType:"jsonp",data:{id:e}}),this.products.fetch({global:!1,dataType:"jsonp",data:{id:e,start:0,size:99}}),this.topics.fetch({global:!1,dataType:"jsonp",data:{id:e,start:0,size:99}})}}))({el:$("#view-brand")})}(),function(){var e=Amour.Model.extend({url:Amour.APIRoot+"beacon/admin/getTopic.do"}),t=Amour.Collection.extend({url:Amour.APIRoot+"beacon/data/listItemByTid.do"}),i=Amour.Collection.extend({url:Amour.APIRoot+"beacon/data/getAllCommentByTopic.do"}),o=Amour.ModelView.extend({template:App.getTemplate("topic-detail")}),n=Amour.CollectionView.extend({ModelView:Amour.ModelView.extend({events:{click:"viewDetail"},className:"media-item",template:App.getTemplate("product-media-item"),viewDetail:function(){App.router.navigate("product/"+this.model.id)}})}),s=Amour.CollectionView.extend({ModelView:Amour.ModelView.extend({className:"comment-item",template:App.getTemplate("comment-item"),serializeData:function(){var e=Amour.ModelView.prototype.serializeData.call(this);return e.formatted_date=moment(e.createTime).format("MM月DD日 HH:mm"),e.likeCount=+e.likeCount,e}})});App.Pages.Topic=new(App.PageView.extend({events:{"click .comment-tip":"viewAllComments"},initPage:function(){this.topic=new e,this.products=new t,this.comments=new i,this.views={topic:new o({model:this.topic,el:this.$(".topic-wrapper")}),products:new n({collection:this.products,el:this.$(".topic-products .media-list")}),comments:new s({collection:this.comments,el:this.$(".comments-list")})}},viewAllComments:function(){App.router.navigate(["topic",this.topic.id,"comments"].join("/"))},render:function(){var e=this.options.topicId;this.topic.fetch({dataType:"jsonp",data:{id:e}}),this.products.fetch({dataType:"jsonp",data:{id:e,start:0,size:99}});var t=this;this.comments.fetch({dataType:"jsonp",data:{tid:e,size:3,max_id:null},success:function(e){t.$(".comment-tip span").text(e.size)}})}}))({el:$("#view-topic")})}(),function(){var e=Amour.Collection.extend({url:Amour.APIRoot+"beacon/data/getAllCommentByTopic.do"}),t=Amour.CollectionView.extend({ModelView:Amour.ModelView.extend({className:"comment-item",template:App.getTemplate("comment-item"),serializeData:function(){var e=Amour.ModelView.prototype.serializeData.call(this);return e.formatted_date=moment(e.createTime).format("MM月DD日 HH:mm"),e.like=e.like||"",e}})});App.Pages.TopicComments=new(App.PageView.extend({initPage:function(){this.comments=new e,this.views={comments:new t({collection:this.comments,el:this.$(".comments-list")})}},render:function(){var e=this.options.topicId;this.comments.fetch({dataType:"jsonp",data:{tid:e,size:99,max_id:null}})}}))({el:$("#view-topic-comments")})}(),function(){var e=new function(){var e=this;this.get=function(t){this.coords?t(this.coords):navigator.geolocation.getCurrentPosition(function(i){e.coords={latitude:i.coords.latitude,longitude:i.coords.longitude},t(e.coords)})},this.distance=function(e,t,i,o){var e=e*Math.PI/180,t=t*Math.PI/180,i=i*Math.PI/180,o=o*Math.PI/180,n=6371,s=(o-t)*Math.cos((e+i)/2),a=i-e,r=Math.sqrt(s*s+a*a)*n;return r>1?parseInt(10*r)/10+"km":parseInt(1e3*r)+"m"}},t=Amour.Collection.extend({}),i=Amour.CollectionView.extend({ModelView:Amour.ModelView.extend({className:"address-item",template:App.getTemplate("address-item"),render:function(){Amour.ModelView.prototype.render.call(this);var t=this;return e.get(function(i){var o=e.distance(t.model.get("lat"),t.model.get("lng"),i.latitude,i.longitude);t.$(".distance").text(o)}),this}})});App.Pages.Address=new(App.PageView.extend({initPage:function(){this.address=new t,this.views={address:new i({collection:this.address,el:this.$(".address-list")})}},render:function(){var e,t;this.options.brandId?(e=this.options.brandId,t=Amour.APIRoot+"beacon/data/listBrandStores.do"):(e=this.options.productId,t=Amour.APIRoot+"beacon/data/listStoresByItemid.do"),this.address.fetch({dataType:"jsonp",url:t,data:{id:e,cityName:"北京市"}})}}))({el:$("#view-address")})}(),App.start();