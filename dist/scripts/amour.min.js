!function(){if(navigator.userAgent.match(/MQQBrowser/)&&(Backbone.emulateHTTP=!0),navigator.userAgent.match(/IEMobile\/10\.0/)){var e=document.createElement("style");e.appendChild(document.createTextNode("@-ms-viewport{width:auto!important}")),document.getElementsByTagName("head")[0].appendChild(e)}window.location.origin||(window.location.origin=window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")),function(){var e=[],t=[];_.chain(window.location.search.substr(1).split("&")).compact().each(function(i){var n=i.split("=");e.push(n[0]),t.push(n[1])}),window.location.query=_.object(e,t)}(),function(){new FastClick(document.body)}();var t=window.Amour={version:"1.0",APIRoot:"http://123.57.253.146/",StaticURL:"/"};t.isWeixin=/MicroMessenger/i.test(navigator.userAgent),t.isMobile=/iPhone|Android|iPad|Windows Phone/i.test(navigator.userAgent),_.extend(t,Backbone.Events);t.EventAggregator=function(){var e=function(){};return e.extend=Backbone.Model.extend,_.extend(e.prototype,Backbone.Events),e}();window.Handlebars?(t.TPL=Handlebars,Handlebars.render=function(e,t){var e=e||"",t=t||{},i=Handlebars.compile(e);return i(t)},Handlebars.registerHelper("apiFullpath",function(e,i){return t.APIRoot+(e&&"/"==e[0]?e.substr(1):e)}),Handlebars.registerHelper("eq",function(e,t,i){return e==t?i.fn(this):i.inverse(this)}),Handlebars.registerHelper("list",function(e,t){if(Handlebars.Utils.isEmpty(e))return t.inverse(this);var e="object"==typeof e?e:[e];return Handlebars.helpers.each.call(this,e,t)})):window.Mustache?t.TPL=Mustache:t.TPL={render:function(e,t){return e}};var i=t.TPL,n=t.Model=Backbone.Model.extend({initialize:function(e,t){t=t||{},this.initModel&&this.initModel(t)},parse:function(e){return null!=e.response?(this.responseCode=e.code,e.response):e},url:function(){var e=Backbone.Model.prototype.url.call(this);return e+("/"==e.charAt(e.length-1)?"":"/")}}),o=t.Collection=Backbone.Collection.extend({model:n,initialize:function(e,t){t=t||{},this.initCollection&&this.initCollection(t)},parse:function(e){return null!=e.response?(this.responseCode=e.code,null!=e.response.list?(this.size=e.response.size,e.response.list):e.response):e},fetchNext:function(e){var e=e||{};this.next&&(e.url=this.next,this.fetch(e))},fetchPrev:function(e){var e=e||{};this.previous&&(e.url=this.previous,this.fetch(e))}}),r=t.View=Backbone.View.extend({initialize:function(e){this.initView&&this.initView(e||{})},renderTemplate:function(e,n){var n=n||_.result(this,"template")||"",e=this.mixinTemplateHelpers(e);return this.$el.html(i.render(n,e)),this.$el.find("img[data-src]").addBack("img[data-src]").each(function(){t.loadImage($(this),$(this).data("src"))}),this.$el.find(".img[data-bg-src]").addBack(".img[data-bg-src]").each(function(){t.loadBgImage($(this),$(this).data("bg-src"))}),this},mixinTemplateHelpers:function(e){var e=e||{};return _.extend(e,_.result(this,"templateHelpers"))}}),s=t.ModelView=r.extend({listenToModel:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"hide",this.hide)},initView:function(e){this.model=this.model||new n,this.listenToModel(),this.initModelView&&this.initModelView(e||{})},setModel:function(e){this.stopListening(this.model),this.model=e,this.listenToModel()},hide:function(){this.remove()},serializeData:function(){return this.model?this.model.toJSON():{}},render:function(){return this.renderTemplate(this.serializeData())}});t.CollectionView=r.extend({ModelView:s,listenToCollection:function(){this.listenTo(this.collection,"reset",this.addAll),this.listenTo(this.collection,"add",this.addOne),this.listenTo(this.collection,"remove",this.removeOne)},initView:function(e){e=e||{},this.reverse=e.reverse===!0,this.collection=this.collection||new o,this.listenToCollection(),this.initCollectionView&&this.initCollectionView(e)},setCollection:function(e){this.stopListening(this.collection),this.collection=e,this.listenToCollection()},renderItem:function(e){var t=new this.ModelView({model:e});return t.render().el},removeOne:function(e){e.trigger("hide")},addOne:function(e){var t=this.reverse?"prepend":"append";this.$el[t](this.renderItem(e))},addAll:function(e,t){if(t&&t.previousModels&&_.each(t.previousModels,function(e){e.trigger("hide")}),this.collection){var i=this.collection.reduce(function(e,t){return e.concat(this.renderItem(t))},[],this);this.$el.html(this.reverse?i.reverse():i)}},render:function(){return this.addAll(),this}});t.storage=new function(){this.set=function(e,t){localStorage.setItem(e,t)},this.get=function(e){return localStorage.getItem(e)},this.del=function(e){localStorage.removeItem(e)};try{localStorage.setItem("TEST_LOCALSTORAGE",1)}catch(e){alert("您的浏览器可能开启了“无痕(Private)浏览”，可能需要多次输入用户名和密码以保持登录状态"),this.vault={},this.set=function(e,t){this.vault[e]=t},this.get=function(e){return this.vault[e]},this.del=function(e){this.vault[e]=null}}},t.openWindow=function(e){window.open(e,"_self","location=no")},t.optimizeImage=function(e){return e},t.imageFullpath=function(e,i){i=i||{};var n=/^http:\/\//.test(e)?e:t.StaticURL+e;return i.optimize===!1?n:t.optimizeImage(n)},t.loadImage=function(e,i,n){if(n=n||{},!i)return void(n.error&&n.error());var o=new Image,r=t.imageFullpath(i,n);o.onload=function(){e.removeClass("img-loading"),e.attr("src",r),n.success&&n.success()},o.onerror=function(){e.removeClass("img-loading").addClass("img-broken"),n.error&&n.error()},e.attr("src","data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"),e.removeClass("img-broken").addClass("img-loading"),o.src=r},t.loadBgImage=function(e,i,n){if(n=n||{},!i)return void(n.error&&n.error());if("none"==i)return e.css("background-image","none"),void(n.success&&n.success());var o=new Image,r=t.imageFullpath(i,n);o.onload=function(){e.removeClass("img-loading"),e.css("background-image","url("+r+")"),n.success&&n.success()},o.onerror=function(){e.removeClass("img-loading").addClass("img-broken"),n.error&&n.error()},e.removeClass("img-broken").addClass("img-loading"),o.src=r},t.fillImages=function(){var e=1+$("img[data-src]").length+$(".img[data-bg-src]").length,i=_.after(e,function(){t.imagesLoaded=!0,t.trigger("ImagesLoaded")});i(),$("img[data-src]").each(function(){var e=$(this).data("src");t.loadImage($(this),e,{success:i,error:i})}),$(".img[data-bg-src]").each(function(){var e=$(this).data("bg-src");t.loadBgImage($(this),e,{success:i,error:i})})};var a=function(){var e=t.storage.get("auth-token"),i=Backbone.sync;Backbone.sync=function(t,n,o){return _.extend(o.headers||(o.headers={}),{"Accept-Language":"zh-CN"}),e&&_.extend(o.headers,{Authorization:"Token "+e}),i.call(n,t,n,o)},t.TokenAuth={get:function(){return _.clone(e)},set:function(i){e=_.clone(i),t.storage.set("auth-token",e)},clear:function(){e=null,t.storage.del("auth-token")}}},l=function(){_.extend(t.ajax={},Backbone.Events),$(document).ajaxStart(function(){t.ajax.trigger("start")}),$(document).ajaxStop(function(){t.ajax.trigger("stop")}),$(document).ajaxError(function(e,i,n,o){i.responseJSON||{};401==i.status||499==i.status?(t.TokenAuth.clear(),t.ajax.trigger("unauthorized")):403==i.status?(t.TokenAuth.clear(),t.ajax.trigger("forbidden")):"GET"==n.type&&"abort"!=i.statusText&&t.ajax.trigger("error")})};window["amour-lazy-loading-images"]||t.fillImages(),a(),l()}();